<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<title>Kafka Producer</title>
</head>
<body class="p-4">
<div class="container">
    <h1 class="mb-4">Kafka Topics</h1>
    
    <!-- Tab navigation -->
    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab" aria-controls="send" aria-selected="true">Send Message</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab" aria-controls="create" aria-selected="false">Create Topic</button>
        </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content" id="myTabContent">
        <!-- Send Message Tab -->
        <div class="tab-pane fade show active" id="send" role="tabpanel" aria-labelledby="send-tab">
            <div class="mb-3">
                <select id="topicSelect" class="form-select">
                    <option selected>Choose a Topic</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="message" class="form-label">JSON Message:</label>
                <textarea id="message" name="message" class="form-control" rows="15"></textarea>
            </div>
            <button onclick="sendMessage()" class="btn btn-primary">Send</button>
            
            <div class="mt-3">
                <label for="jsonResponse" class="form-label">Response:</label>
                <textarea id="jsonResponse" class="form-control" rows="5" readonly></textarea>
            </div>
        </div>
        
        <!-- Create Topic Tab -->
        <div class="tab-pane fade" id="create" role="tabpanel" aria-labelledby="create-tab">
            <div class="mb-3">
                <label for="newTopicName" class="form-label">Topic Name:</label>
                <input type="text" class="form-control" id="newTopicName">
            </div>
            <div class="mb-3">
                <label for="numPartitions" class="form-label">Number of Partitions:</label>
                <input type="number" class="form-control" id="numPartitions" value="1" min="1">
            </div>
            <div class="mb-3">
                <label for="replicationFactor" class="form-label">Replication Factor:</label>
                <input type="number" class="form-control" id="replicationFactor" value="1" min="1">
            </div>
            <button onclick="createTopic()" class="btn btn-success">Create Topic</button>
            
            <div class="mt-3">
                <label for="createTopicResponse" class="form-label">Response:</label>
                <textarea id="createTopicResponse" class="form-control" rows="5" readonly></textarea>
            </div>
        </div>
    </div>
</div>

<script src="/js/bootstrap.bundle.min.js"></script>
<script>
// Load topics on page load
loadTopics();

// Function to load topics
function loadTopics() {
    fetch('http://localhost:3000/topics')
        .then(response => response.json())
        .then(data => {
            const topicSelect = document.getElementById('topicSelect');
            // Clear existing options except the first one
            while(topicSelect.options.length > 1) {
                topicSelect.remove(1);
            }
            
            data.forEach(topic => {
                const option = document.createElement('option');
                option.textContent = topic;
                option.value = topic; // Set value of option to the topic
                topicSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching topics:', error));
}

let selectedTopic = ''; // Variable to store selected topic

async function sendMessage() {
    try {
        const message = document.getElementById('message').value;
        const topicSelect = document.getElementById('topicSelect');
        selectedTopic = topicSelect.options[topicSelect.selectedIndex].value; // Store selected topic
        
        if (selectedTopic === "Choose a Topic") {
            document.getElementById('jsonResponse').value = "Please select a topic";
            return;
        }
        
        const response = await fetch('http://localhost:3000/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message, topic: selectedTopic }),
        });
        
        const result = await response.text();
        document.getElementById('jsonResponse').value = result;
    } catch (error) {
        document.getElementById('jsonResponse').value = "Error: " + error.message;
    }
}

async function createTopic() {
    try {
        const topicName = document.getElementById('newTopicName').value;
        const numPartitions = parseInt(document.getElementById('numPartitions').value);
        const replicationFactor = parseInt(document.getElementById('replicationFactor').value);
        
        if (!topicName) {
            document.getElementById('createTopicResponse').value = "Topic name is required";
            return;
        }
        
        const response = await fetch('http://localhost:3000/create-topic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                topicName: topicName,
                numPartitions: numPartitions,
                replicationFactor: replicationFactor
            }),
        });
        
        const result = await response.json();
        document.getElementById('createTopicResponse').value = JSON.stringify(result, null, 2);
        
        // Reload topics after successful creation
        if (response.ok) {
            setTimeout(loadTopics, 1000); // Give Kafka a moment to register the new topic
        }
    } catch (error) {
        document.getElementById('createTopicResponse').value = "Error: " + error.message;
    }
}
</script>
</body>
</html>